d9538df396db83353f9abefcc01559c7
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _createForOfIteratorHelperLoose(o, allowArrayLike) { var it = typeof Symbol !== "undefined" && o[Symbol.iterator] || o["@@iterator"]; if (it) return (it = it.call(o)).next.bind(it); if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; return function () { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

var invariant = require('invariant');

var ViewabilityHelper = function () {
  function ViewabilityHelper() {
    var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {
      viewAreaCoveragePercentThreshold: 0
    };
    (0, _classCallCheck2.default)(this, ViewabilityHelper);
    this._hasInteracted = false;
    this._timers = new Set();
    this._viewableIndices = [];
    this._viewableItems = new Map();
    this._config = config;
  }

  (0, _createClass2.default)(ViewabilityHelper, [{
    key: "dispose",
    value: function dispose() {
      this._timers.forEach(clearTimeout);
    }
  }, {
    key: "computeViewableItems",
    value: function computeViewableItems(itemCount, scrollOffset, viewportHeight, getFrameMetrics, renderRange) {
      var _this$_config = this._config,
          itemVisiblePercentThreshold = _this$_config.itemVisiblePercentThreshold,
          viewAreaCoveragePercentThreshold = _this$_config.viewAreaCoveragePercentThreshold;
      var viewAreaMode = viewAreaCoveragePercentThreshold != null;
      var viewablePercentThreshold = viewAreaMode ? viewAreaCoveragePercentThreshold : itemVisiblePercentThreshold;
      invariant(viewablePercentThreshold != null && itemVisiblePercentThreshold != null !== (viewAreaCoveragePercentThreshold != null), 'Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold');
      var viewableIndices = [];

      if (itemCount === 0) {
        return viewableIndices;
      }

      var firstVisible = -1;

      var _ref = renderRange || {
        first: 0,
        last: itemCount - 1
      },
          first = _ref.first,
          last = _ref.last;

      if (last >= itemCount) {
        console.warn('Invalid render range computing viewability ' + JSON.stringify({
          renderRange: renderRange,
          itemCount: itemCount
        }));
        return [];
      }

      for (var idx = first; idx <= last; idx++) {
        var metrics = getFrameMetrics(idx);

        if (!metrics) {
          continue;
        }

        var top = metrics.offset - scrollOffset;
        var bottom = top + metrics.length;

        if (top < viewportHeight && bottom > 0) {
          firstVisible = idx;

          if (_isViewable(viewAreaMode, viewablePercentThreshold, top, bottom, viewportHeight, metrics.length)) {
            viewableIndices.push(idx);
          }
        } else if (firstVisible >= 0) {
          break;
        }
      }

      return viewableIndices;
    }
  }, {
    key: "onUpdate",
    value: function onUpdate(itemCount, scrollOffset, viewportHeight, getFrameMetrics, createViewToken, onViewableItemsChanged, renderRange) {
      var _this = this;

      if (this._config.waitForInteraction && !this._hasInteracted || itemCount === 0 || !getFrameMetrics(0)) {
        return;
      }

      var viewableIndices = [];

      if (itemCount) {
        viewableIndices = this.computeViewableItems(itemCount, scrollOffset, viewportHeight, getFrameMetrics, renderRange);
      }

      if (this._viewableIndices.length === viewableIndices.length && this._viewableIndices.every(function (v, ii) {
        return v === viewableIndices[ii];
      })) {
        return;
      }

      this._viewableIndices = viewableIndices;

      if (this._config.minimumViewTime) {
        var handle = setTimeout(function () {
          _this._timers.delete(handle);

          _this._onUpdateSync(viewableIndices, onViewableItemsChanged, createViewToken);
        }, this._config.minimumViewTime);

        this._timers.add(handle);
      } else {
        this._onUpdateSync(viewableIndices, onViewableItemsChanged, createViewToken);
      }
    }
  }, {
    key: "resetViewableIndices",
    value: function resetViewableIndices() {
      this._viewableIndices = [];
    }
  }, {
    key: "recordInteraction",
    value: function recordInteraction() {
      this._hasInteracted = true;
    }
  }, {
    key: "_onUpdateSync",
    value: function _onUpdateSync(viewableIndicesToCheck, onViewableItemsChanged, createViewToken) {
      var _this2 = this;

      viewableIndicesToCheck = viewableIndicesToCheck.filter(function (ii) {
        return _this2._viewableIndices.includes(ii);
      });
      var prevItems = this._viewableItems;
      var nextItems = new Map(viewableIndicesToCheck.map(function (ii) {
        var viewable = createViewToken(ii, true);
        return [viewable.key, viewable];
      }));
      var changed = [];

      for (var _iterator = _createForOfIteratorHelperLoose(nextItems), _step; !(_step = _iterator()).done;) {
        var _ref2 = _step.value;

        var _ref3 = (0, _slicedToArray2.default)(_ref2, 2);

        var key = _ref3[0];
        var viewable = _ref3[1];

        if (!prevItems.has(key)) {
          changed.push(viewable);
        }
      }

      for (var _iterator2 = _createForOfIteratorHelperLoose(prevItems), _step2; !(_step2 = _iterator2()).done;) {
        var _ref4 = _step2.value;

        var _ref5 = (0, _slicedToArray2.default)(_ref4, 2);

        var _key = _ref5[0];
        var _viewable = _ref5[1];

        if (!nextItems.has(_key)) {
          changed.push(_objectSpread(_objectSpread({}, _viewable), {}, {
            isViewable: false
          }));
        }
      }

      if (changed.length > 0) {
        this._viewableItems = nextItems;
        onViewableItemsChanged({
          viewableItems: Array.from(nextItems.values()),
          changed: changed,
          viewabilityConfig: this._config
        });
      }
    }
  }]);
  return ViewabilityHelper;
}();

function _isViewable(viewAreaMode, viewablePercentThreshold, top, bottom, viewportHeight, itemLength) {
  if (_isEntirelyVisible(top, bottom, viewportHeight)) {
    return true;
  } else {
    var pixels = _getPixelsVisible(top, bottom, viewportHeight);

    var percent = 100 * (viewAreaMode ? pixels / viewportHeight : pixels / itemLength);
    return percent >= viewablePercentThreshold;
  }
}

function _getPixelsVisible(top, bottom, viewportHeight) {
  var visibleHeight = Math.min(bottom, viewportHeight) - Math.max(top, 0);
  return Math.max(0, visibleHeight);
}

function _isEntirelyVisible(top, bottom, viewportHeight) {
  return top >= 0 && bottom <= viewportHeight && bottom > top;
}

module.exports = ViewabilityHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlZpZXdhYmlsaXR5SGVscGVyLmpzIl0sIm5hbWVzIjpbImludmFyaWFudCIsInJlcXVpcmUiLCJWaWV3YWJpbGl0eUhlbHBlciIsImNvbmZpZyIsInZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkIiwiX2hhc0ludGVyYWN0ZWQiLCJfdGltZXJzIiwiU2V0IiwiX3ZpZXdhYmxlSW5kaWNlcyIsIl92aWV3YWJsZUl0ZW1zIiwiTWFwIiwiX2NvbmZpZyIsImZvckVhY2giLCJjbGVhclRpbWVvdXQiLCJpdGVtQ291bnQiLCJzY3JvbGxPZmZzZXQiLCJ2aWV3cG9ydEhlaWdodCIsImdldEZyYW1lTWV0cmljcyIsInJlbmRlclJhbmdlIiwiaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkIiwidmlld0FyZWFNb2RlIiwidmlld2FibGVQZXJjZW50VGhyZXNob2xkIiwidmlld2FibGVJbmRpY2VzIiwiZmlyc3RWaXNpYmxlIiwiZmlyc3QiLCJsYXN0IiwiY29uc29sZSIsIndhcm4iLCJKU09OIiwic3RyaW5naWZ5IiwiaWR4IiwibWV0cmljcyIsInRvcCIsIm9mZnNldCIsImJvdHRvbSIsImxlbmd0aCIsIl9pc1ZpZXdhYmxlIiwicHVzaCIsImNyZWF0ZVZpZXdUb2tlbiIsIm9uVmlld2FibGVJdGVtc0NoYW5nZWQiLCJ3YWl0Rm9ySW50ZXJhY3Rpb24iLCJjb21wdXRlVmlld2FibGVJdGVtcyIsImV2ZXJ5IiwidiIsImlpIiwibWluaW11bVZpZXdUaW1lIiwiaGFuZGxlIiwic2V0VGltZW91dCIsImRlbGV0ZSIsIl9vblVwZGF0ZVN5bmMiLCJhZGQiLCJ2aWV3YWJsZUluZGljZXNUb0NoZWNrIiwiZmlsdGVyIiwiaW5jbHVkZXMiLCJwcmV2SXRlbXMiLCJuZXh0SXRlbXMiLCJtYXAiLCJ2aWV3YWJsZSIsImtleSIsImNoYW5nZWQiLCJoYXMiLCJpc1ZpZXdhYmxlIiwidmlld2FibGVJdGVtcyIsIkFycmF5IiwiZnJvbSIsInZhbHVlcyIsInZpZXdhYmlsaXR5Q29uZmlnIiwiaXRlbUxlbmd0aCIsIl9pc0VudGlyZWx5VmlzaWJsZSIsInBpeGVscyIsIl9nZXRQaXhlbHNWaXNpYmxlIiwicGVyY2VudCIsInZpc2libGVIZWlnaHQiLCJNYXRoIiwibWluIiwibWF4IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBVUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQXpCOztJQThETUMsaUI7QUFPSiwrQkFFRTtBQUFBLFFBREFDLE1BQ0EsdUVBRDRCO0FBQUNDLE1BQUFBLGdDQUFnQyxFQUFFO0FBQW5DLEtBQzVCO0FBQUE7QUFBQSxTQVBGQyxjQU9FLEdBUHdCLEtBT3hCO0FBQUEsU0FORkMsT0FNRSxHQU5xQixJQUFJQyxHQUFKLEVBTXJCO0FBQUEsU0FMRkMsZ0JBS0UsR0FMZ0MsRUFLaEM7QUFBQSxTQUpGQyxjQUlFLEdBSnVDLElBQUlDLEdBQUosRUFJdkM7QUFDQSxTQUFLQyxPQUFMLEdBQWVSLE1BQWY7QUFDRDs7OztXQUtELG1CQUFVO0FBSVIsV0FBS0csT0FBTCxDQUFhTSxPQUFiLENBQXFCQyxZQUFyQjtBQUNEOzs7V0FLRCw4QkFDRUMsU0FERixFQUVFQyxZQUZGLEVBR0VDLGNBSEYsRUFJRUMsZUFKRixFQVlFQyxXQVpGLEVBaUJpQjtBQUNmLDBCQUdJLEtBQUtQLE9BSFQ7QUFBQSxVQUNFUSwyQkFERixpQkFDRUEsMkJBREY7QUFBQSxVQUVFZixnQ0FGRixpQkFFRUEsZ0NBRkY7QUFJQSxVQUFNZ0IsWUFBWSxHQUFHaEIsZ0NBQWdDLElBQUksSUFBekQ7QUFDQSxVQUFNaUIsd0JBQXdCLEdBQUdELFlBQVksR0FDekNoQixnQ0FEeUMsR0FFekNlLDJCQUZKO0FBR0FuQixNQUFBQSxTQUFTLENBQ1BxQix3QkFBd0IsSUFBSSxJQUE1QixJQUNHRiwyQkFBMkIsSUFBSSxJQUFoQyxNQUNHZixnQ0FBZ0MsSUFBSSxJQUR2QyxDQUZLLEVBSVAseUZBSk8sQ0FBVDtBQU1B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RUEsV0FBT0ksT0FBTyxJQUFJbEQsd0JBQWxCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTaUQsaUJBQVQsQ0FDRXRDLEdBREYsRUFFRUUsTUFGRixFQUdFbEIsY0FIRixFQUlVO0FBQ1IsTUFBTXdELGFBQWEsR0FBR0MsSUFBSSxDQUFDQyxHQUFMLENBQVN4QyxNQUFULEVBQWlCbEIsY0FBakIsSUFBbUN5RCxJQUFJLENBQUNFLEdBQUwsQ0FBUzNDLEdBQVQsRUFBYyxDQUFkLENBQXpEO0FBQ0EsU0FBT3lDLElBQUksQ0FBQ0UsR0FBTCxDQUFTLENBQVQsRUFBWUgsYUFBWixDQUFQO0FBQ0Q7O0FBRUQsU0FBU0osa0JBQVQsQ0FDRXBDLEdBREYsRUFFRUUsTUFGRixFQUdFbEIsY0FIRixFQUlXO0FBQ1QsU0FBT2dCLEdBQUcsSUFBSSxDQUFQLElBQVlFLE1BQU0sSUFBSWxCLGNBQXRCLElBQXdDa0IsTUFBTSxHQUFHRixHQUF4RDtBQUNEOztBQUVENEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCM0UsaUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbmV4cG9ydCB0eXBlIFZpZXdUb2tlbiA9IHtcbiAgaXRlbTogYW55LFxuICBrZXk6IHN0cmluZyxcbiAgaW5kZXg6ID9udW1iZXIsXG4gIGlzVmlld2FibGU6IGJvb2xlYW4sXG4gIHNlY3Rpb24/OiBhbnksXG4gIC4uLlxufTtcblxuZXhwb3J0IHR5cGUgVmlld2FiaWxpdHlDb25maWdDYWxsYmFja1BhaXIgPSB7XG4gIHZpZXdhYmlsaXR5Q29uZmlnOiBWaWV3YWJpbGl0eUNvbmZpZyxcbiAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZDogKGluZm86IHtcbiAgICB2aWV3YWJsZUl0ZW1zOiBBcnJheTxWaWV3VG9rZW4+LFxuICAgIGNoYW5nZWQ6IEFycmF5PFZpZXdUb2tlbj4sXG4gICAgLi4uXG4gIH0pID0+IHZvaWQsXG4gIC4uLlxufTtcblxuZXhwb3J0IHR5cGUgVmlld2FiaWxpdHlDb25maWcgPSB7fFxuICAvKipcbiAgICogTWluaW11bSBhbW91bnQgb2YgdGltZSAoaW4gbWlsbGlzZWNvbmRzKSB0aGF0IGFuIGl0ZW0gbXVzdCBiZSBwaHlzaWNhbGx5IHZpZXdhYmxlIGJlZm9yZSB0aGVcbiAgICogdmlld2FiaWxpdHkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZC4gQSBoaWdoIG51bWJlciBtZWFucyB0aGF0IHNjcm9sbGluZyB0aHJvdWdoIGNvbnRlbnQgd2l0aG91dFxuICAgKiBzdG9wcGluZyB3aWxsIG5vdCBtYXJrIHRoZSBjb250ZW50IGFzIHZpZXdhYmxlLlxuICAgKi9cbiAgbWluaW11bVZpZXdUaW1lPzogbnVtYmVyLFxuXG4gIC8qKlxuICAgKiBQZXJjZW50IG9mIHZpZXdwb3J0IHRoYXQgbXVzdCBiZSBjb3ZlcmVkIGZvciBhIHBhcnRpYWxseSBvY2NsdWRlZCBpdGVtIHRvIGNvdW50IGFzXG4gICAqIFwidmlld2FibGVcIiwgMC0xMDAuIEZ1bGx5IHZpc2libGUgaXRlbXMgYXJlIGFsd2F5cyBjb25zaWRlcmVkIHZpZXdhYmxlLiBBIHZhbHVlIG9mIDAgbWVhbnNcbiAgICogdGhhdCBhIHNpbmdsZSBwaXhlbCBpbiB0aGUgdmlld3BvcnQgbWFrZXMgdGhlIGl0ZW0gdmlld2FibGUsIGFuZCBhIHZhbHVlIG9mIDEwMCBtZWFucyB0aGF0XG4gICAqIGFuIGl0ZW0gbXVzdCBiZSBlaXRoZXIgZW50aXJlbHkgdmlzaWJsZSBvciBjb3ZlciB0aGUgZW50aXJlIHZpZXdwb3J0IHRvIGNvdW50IGFzIHZpZXdhYmxlLlxuICAgKi9cbiAgdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQ/OiBudW1iZXIsXG5cbiAgLyoqXG4gICAqIFNpbWlsYXIgdG8gYHZpZXdBcmVhUGVyY2VudFRocmVzaG9sZGAsIGJ1dCBjb25zaWRlcnMgdGhlIHBlcmNlbnQgb2YgdGhlIGl0ZW0gdGhhdCBpcyB2aXNpYmxlLFxuICAgKiByYXRoZXIgdGhhbiB0aGUgZnJhY3Rpb24gb2YgdGhlIHZpZXdhYmxlIGFyZWEgaXQgY292ZXJzLlxuICAgKi9cbiAgaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkPzogbnVtYmVyLFxuXG4gIC8qKlxuICAgKiBOb3RoaW5nIGlzIGNvbnNpZGVyZWQgdmlld2FibGUgdW50aWwgdGhlIHVzZXIgc2Nyb2xscyBvciBgcmVjb3JkSW50ZXJhY3Rpb25gIGlzIGNhbGxlZCBhZnRlclxuICAgKiByZW5kZXIuXG4gICAqL1xuICB3YWl0Rm9ySW50ZXJhY3Rpb24/OiBib29sZWFuLFxufH07XG5cbi8qKlxuICogQSBVdGlsaXR5IGNsYXNzIGZvciBjYWxjdWxhdGluZyB2aWV3YWJsZSBpdGVtcyBiYXNlZCBvbiBjdXJyZW50IG1ldHJpY3MgbGlrZSBzY3JvbGwgcG9zaXRpb24gYW5kXG4gKiBsYXlvdXQuXG4gKlxuICogQW4gaXRlbSBpcyBzYWlkIHRvIGJlIGluIGEgXCJ2aWV3YWJsZVwiIHN0YXRlIHdoZW4gYW55IG9mIHRoZSBmb2xsb3dpbmdcbiAqIGlzIHRydWUgZm9yIGxvbmdlciB0aGFuIGBtaW5pbXVtVmlld1RpbWVgIG1pbGxpc2Vjb25kcyAoYWZ0ZXIgYW4gaW50ZXJhY3Rpb24gaWYgYHdhaXRGb3JJbnRlcmFjdGlvbmBcbiAqIGlzIHRydWUpOlxuICpcbiAqIC0gT2NjdXB5aW5nID49IGB2aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZGAgb2YgdGhlIHZpZXcgYXJlYSBYT1IgZnJhY3Rpb24gb2YgdGhlIGl0ZW1cbiAqICAgdmlzaWJsZSBpbiB0aGUgdmlldyBhcmVhID49IGBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGRgLlxuICogLSBFbnRpcmVseSB2aXNpYmxlIG9uIHNjcmVlblxuICovXG5jbGFzcyBWaWV3YWJpbGl0eUhlbHBlciB7XG4gIF9jb25maWc6IFZpZXdhYmlsaXR5Q29uZmlnO1xuICBfaGFzSW50ZXJhY3RlZDogYm9vbGVhbiA9IGZhbHNlO1xuICBfdGltZXJzOiBTZXQ8bnVtYmVyPiA9IG5ldyBTZXQoKTtcbiAgX3ZpZXdhYmxlSW5kaWNlczogQXJyYXk8bnVtYmVyPiA9IFtdO1xuICBfdmlld2FibGVJdGVtczogTWFwPHN0cmluZywgVmlld1Rva2VuPiA9IG5ldyBNYXAoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBjb25maWc6IFZpZXdhYmlsaXR5Q29uZmlnID0ge3ZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkOiAwfSxcbiAgKSB7XG4gICAgdGhpcy5fY29uZmlnID0gY29uZmlnO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFudXAsIGUuZy4gb24gdW5tb3VudC4gQ2xlYXJzIGFueSBwZW5kaW5nIHRpbWVycy5cbiAgICovXG4gIGRpc3Bvc2UoKSB7XG4gICAgLyogJEZsb3dGaXhNZSg+PTAuNjMuMCBzaXRlPXJlYWN0X25hdGl2ZV9mYikgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW5cbiAgICAgKiBlcnJvciBmb3VuZCB3aGVuIEZsb3cgdjAuNjMgd2FzIGRlcGxveWVkLiBUbyBzZWUgdGhlIGVycm9yIGRlbGV0ZSB0aGlzXG4gICAgICogY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgdGhpcy5fdGltZXJzLmZvckVhY2goY2xlYXJUaW1lb3V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIHdoaWNoIGl0ZW1zIGFyZSB2aWV3YWJsZSBiYXNlZCBvbiB0aGUgY3VycmVudCBtZXRyaWNzIGFuZCBjb25maWcuXG4gICAqL1xuICBjb21wdXRlVmlld2FibGVJdGVtcyhcbiAgICBpdGVtQ291bnQ6IG51bWJlcixcbiAgICBzY3JvbGxPZmZzZXQ6IG51bWJlcixcbiAgICB2aWV3cG9ydEhlaWdodDogbnVtYmVyLFxuICAgIGdldEZyYW1lTWV0cmljczogKFxuICAgICAgaW5kZXg6IG51bWJlcixcbiAgICApID0+ID97XG4gICAgICBsZW5ndGg6IG51bWJlcixcbiAgICAgIG9mZnNldDogbnVtYmVyLFxuICAgICAgLi4uXG4gICAgfSxcbiAgICAvLyBPcHRpb25hbCBvcHRpbWl6YXRpb24gdG8gcmVkdWNlIHRoZSBzY2FuIHNpemVcbiAgICByZW5kZXJSYW5nZT86IHtcbiAgICAgIGZpcnN0OiBudW1iZXIsXG4gICAgICBsYXN0OiBudW1iZXIsXG4gICAgICAuLi5cbiAgICB9LFxuICApOiBBcnJheTxudW1iZXI+IHtcbiAgICBjb25zdCB7XG4gICAgICBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQsXG4gICAgICB2aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZCxcbiAgICB9ID0gdGhpcy5fY29uZmlnO1xuICAgIGNvbnN0IHZpZXdBcmVhTW9kZSA9IHZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkICE9IG51bGw7XG4gICAgY29uc3Qgdmlld2FibGVQZXJjZW50VGhyZXNob2xkID0gdmlld0FyZWFNb2RlXG4gICAgICA/IHZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkXG4gICAgICA6IGl0ZW1WaXNpYmxlUGVyY2VudFRocmVzaG9sZDtcbiAgICBpbnZhcmlhbnQoXG4gICAgICB2aWV3YWJsZVBlcmNlbnRUaHJlc2hvbGQgIT0gbnVsbCAmJlxuICAgICAgICAoaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkICE9IG51bGwpICE9PVxuICAgICAgICAgICh2aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZCAhPSBudWxsKSxcbiAgICAgICdNdXN0IHNldCBleGFjdGx5IG9uZSBvZiBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQgb3Igdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQnLFxuICAgICk7XG4gICAgY29uc3Qgdmlld2FibGVJbmRpY2VzID0gW107XG4gICAgaWYgKGl0ZW1Db3VudCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHZpZXdhYmxlSW5kaWNlcztcbiAgICB9XG4gICAgbGV0IGZpcnN0VmlzaWJsZSA9IC0xO1xuICAgIGNvbnN0IHtmaXJzdCwgbGFzdH0gPSByZW5kZXJSYW5nZSB8fCB7Zmlyc3Q6IDAsIGxhc3Q6IGl0ZW1Db3VudCAtIDF9O1xuICAgIGlmIChsYXN0ID49IGl0ZW1Db3VudCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAnSW52YWxpZCByZW5kZXIgcmFuZ2UgY29tcHV0aW5nIHZpZXdhYmlsaXR5ICcgK1xuICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtyZW5kZXJSYW5nZSwgaXRlbUNvdW50fSksXG4gICAgICApO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBmb3IgKGxldCBpZHggPSBmaXJzdDsgaWR4IDw9IGxhc3Q7IGlkeCsrKSB7XG4gICAgICBjb25zdCBtZXRyaWNzID0gZ2V0RnJhbWVNZXRyaWNzKGlkeCk7XG4gICAgICBpZiAoIW1ldHJpY3MpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCB0b3AgPSBtZXRyaWNzLm9mZnNldCAtIHNjcm9sbE9mZnNldDtcbiAgICAgIGNvbnN0IGJvdHRvbSA9IHRvcCArIG1ldHJpY3MubGVuZ3RoO1xuICAgICAgaWYgKHRvcCA8IHZpZXdwb3J0SGVpZ2h0ICYmIGJvdHRvbSA+IDApIHtcbiAgICAgICAgZmlyc3RWaXNpYmxlID0gaWR4O1xuICAgICAgICBpZiAoXG4gICAgICAgICAgX2lzVmlld2FibGUoXG4gICAgICAgICAgICB2aWV3QXJlYU1vZGUsXG4gICAgICAgICAgICB2aWV3YWJsZVBlcmNlbnRUaHJlc2hvbGQsXG4gICAgICAgICAgICB0b3AsXG4gICAgICAgICAgICBib3R0b20sXG4gICAgICAgICAgICB2aWV3cG9ydEhlaWdodCxcbiAgICAgICAgICAgIG1ldHJpY3MubGVuZ3RoLFxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgdmlld2FibGVJbmRpY2VzLnB1c2goaWR4KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChmaXJzdFZpc2libGUgPj0gMCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZpZXdhYmxlSW5kaWNlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBGaWd1cmVzIG91dCB3aGljaCBpdGVtcyBhcmUgdmlld2FibGUgYW5kIGhvdyB0aGF0IGhhcyBjaGFuZ2VkIGZyb20gYmVmb3JlIGFuZCBjYWxsc1xuICAgKiBgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZGAgYXMgYXBwcm9wcmlhdGUuXG4gICAqL1xuICBvblVwZGF0ZShcbiAgICBpdGVtQ291bnQ6IG51bWJlcixcbiAgICBzY3JvbGxPZmZzZXQ6IG51bWJlcixcbiAgICB2aWV3cG9ydEhlaWdodDogbnVtYmVyLFxuICAgIGdldEZyYW1lTWV0cmljczogKFxuICAgICAgaW5kZXg6IG51bWJlcixcbiAgICApID0+ID97XG4gICAgICBsZW5ndGg6IG51bWJlcixcbiAgICAgIG9mZnNldDogbnVtYmVyLFxuICAgICAgLi4uXG4gICAgfSxcbiAgICBjcmVhdGVWaWV3VG9rZW46IChpbmRleDogbnVtYmVyLCBpc1ZpZXdhYmxlOiBib29sZWFuKSA9PiBWaWV3VG9rZW4sXG4gICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZDogKHtcbiAgICAgIHZpZXdhYmxlSXRlbXM6IEFycmF5PFZpZXdUb2tlbj4sXG4gICAgICBjaGFuZ2VkOiBBcnJheTxWaWV3VG9rZW4+LFxuICAgICAgLi4uXG4gICAgfSkgPT4gdm9pZCxcbiAgICAvLyBPcHRpb25hbCBvcHRpbWl6YXRpb24gdG8gcmVkdWNlIHRoZSBzY2FuIHNpemVcbiAgICByZW5kZXJSYW5nZT86IHtcbiAgICAgIGZpcnN0OiBudW1iZXIsXG4gICAgICBsYXN0OiBudW1iZXIsXG4gICAgICAuLi5cbiAgICB9LFxuICApOiB2b2lkIHtcbiAgICBpZiAoXG4gICAgICAodGhpcy5fY29uZmlnLndhaXRGb3JJbnRlcmFjdGlvbiAmJiAhdGhpcy5faGFzSW50ZXJhY3RlZCkgfHxcbiAgICAgIGl0ZW1Db3VudCA9PT0gMCB8fFxuICAgICAgIWdldEZyYW1lTWV0cmljcygwKVxuICAgICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgdmlld2FibGVJbmRpY2VzID0gW107XG4gICAgaWYgKGl0ZW1Db3VudCkge1xuICAgICAgdmlld2FibGVJbmRpY2VzID0gdGhpcy5jb21wdXRlVmlld2FibGVJdGVtcyhcbiAgICAgICAgaXRlbUNvdW50LFxuICAgICAgICBzY3JvbGxPZmZzZXQsXG4gICAgICAgIHZpZXdwb3J0SGVpZ2h0LFxuICAgICAgICBnZXRGcmFtZU1ldHJpY3MsXG4gICAgICAgIHJlbmRlclJhbmdlLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgdGhpcy5fdmlld2FibGVJbmRpY2VzLmxlbmd0aCA9PT0gdmlld2FibGVJbmRpY2VzLmxlbmd0aCAmJlxuICAgICAgdGhpcy5fdmlld2FibGVJbmRpY2VzLmV2ZXJ5KCh2LCBpaSkgPT4gdiA9PT0gdmlld2FibGVJbmRpY2VzW2lpXSlcbiAgICApIHtcbiAgICAgIC8vIFdlIG1pZ2h0IGdldCBhIGxvdCBvZiBzY3JvbGwgZXZlbnRzIHdoZXJlIHZpc2liaWxpdHkgZG9lc24ndCBjaGFuZ2UgYW5kIHdlIGRvbid0IHdhbnQgdG8gZG9cbiAgICAgIC8vIGV4dHJhIHdvcmsgaW4gdGhvc2UgY2FzZXMuXG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3ZpZXdhYmxlSW5kaWNlcyA9IHZpZXdhYmxlSW5kaWNlcztcbiAgICBpZiAodGhpcy5fY29uZmlnLm1pbmltdW1WaWV3VGltZSkge1xuICAgICAgY29uc3QgaGFuZGxlID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIC8qICRGbG93Rml4TWUoPj0wLjYzLjAgc2l0ZT1yZWFjdF9uYXRpdmVfZmIpIFRoaXMgY29tbWVudCBzdXBwcmVzc2VzIGFuXG4gICAgICAgICAqIGVycm9yIGZvdW5kIHdoZW4gRmxvdyB2MC42MyB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IgZGVsZXRlXG4gICAgICAgICAqIHRoaXMgY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgICAgIHRoaXMuX3RpbWVycy5kZWxldGUoaGFuZGxlKTtcbiAgICAgICAgdGhpcy5fb25VcGRhdGVTeW5jKFxuICAgICAgICAgIHZpZXdhYmxlSW5kaWNlcyxcbiAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkLFxuICAgICAgICAgIGNyZWF0ZVZpZXdUb2tlbixcbiAgICAgICAgKTtcbiAgICAgIH0sIHRoaXMuX2NvbmZpZy5taW5pbXVtVmlld1RpbWUpO1xuICAgICAgLyogJEZsb3dGaXhNZSg+PTAuNjMuMCBzaXRlPXJlYWN0X25hdGl2ZV9mYikgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW5cbiAgICAgICAqIGVycm9yIGZvdW5kIHdoZW4gRmxvdyB2MC42MyB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IgZGVsZXRlIHRoaXNcbiAgICAgICAqIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgICAgdGhpcy5fdGltZXJzLmFkZChoYW5kbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9vblVwZGF0ZVN5bmMoXG4gICAgICAgIHZpZXdhYmxlSW5kaWNlcyxcbiAgICAgICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCxcbiAgICAgICAgY3JlYXRlVmlld1Rva2VuLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogY2xlYW4tdXAgY2FjaGVkIF92aWV3YWJsZUluZGljZXMgdG8gZXZhbHVhdGUgY2hhbmdlZCBpdGVtcyBvbiBuZXh0IHVwZGF0ZVxuICAgKi9cbiAgcmVzZXRWaWV3YWJsZUluZGljZXMoKSB7XG4gICAgdGhpcy5fdmlld2FibGVJbmRpY2VzID0gW107XG4gIH1cblxuICAvKipcbiAgICogUmVjb3JkcyB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBoYXBwZW5lZCBldmVuIGlmIHRoZXJlIGhhcyBiZWVuIG5vIHNjcm9sbC5cbiAgICovXG4gIHJlY29yZEludGVyYWN0aW9uKCkge1xuICAgIHRoaXMuX2hhc0ludGVyYWN0ZWQgPSB0cnVlO1xuICB9XG5cbiAgX29uVXBkYXRlU3luYyhcbiAgICB2aWV3YWJsZUluZGljZXNUb0NoZWNrLFxuICAgIG9uVmlld2FibGVJdGVtc0NoYW5nZWQsXG4gICAgY3JlYXRlVmlld1Rva2VuLFxuICApIHtcbiAgICAvLyBGaWx0ZXIgb3V0IGluZGljZXMgdGhhdCBoYXZlIGdvbmUgb3V0IG9mIHZpZXcgc2luY2UgdGhpcyBjYWxsIHdhcyBzY2hlZHVsZWQuXG4gICAgdmlld2FibGVJbmRpY2VzVG9DaGVjayA9IHZpZXdhYmxlSW5kaWNlc1RvQ2hlY2suZmlsdGVyKGlpID0+XG4gICAgICB0aGlzLl92aWV3YWJsZUluZGljZXMuaW5jbHVkZXMoaWkpLFxuICAgICk7XG4gICAgY29uc3QgcHJldkl0ZW1zID0gdGhpcy5fdmlld2FibGVJdGVtcztcbiAgICBjb25zdCBuZXh0SXRlbXMgPSBuZXcgTWFwKFxuICAgICAgdmlld2FibGVJbmRpY2VzVG9DaGVjay5tYXAoaWkgPT4ge1xuICAgICAgICBjb25zdCB2aWV3YWJsZSA9IGNyZWF0ZVZpZXdUb2tlbihpaSwgdHJ1ZSk7XG4gICAgICAgIHJldHVybiBbdmlld2FibGUua2V5LCB2aWV3YWJsZV07XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgY29uc3QgY2hhbmdlZCA9IFtdO1xuICAgIGZvciAoY29uc3QgW2tleSwgdmlld2FibGVdIG9mIG5leHRJdGVtcykge1xuICAgICAgaWYgKCFwcmV2SXRlbXMuaGFzKGtleSkpIHtcbiAgICAgICAgY2hhbmdlZC5wdXNoKHZpZXdhYmxlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCBba2V5LCB2aWV3YWJsZV0gb2YgcHJldkl0ZW1zKSB7XG4gICAgICBpZiAoIW5leHRJdGVtcy5oYXMoa2V5KSkge1xuICAgICAgICBjaGFuZ2VkLnB1c2goey4uLnZpZXdhYmxlLCBpc1ZpZXdhYmxlOiBmYWxzZX0pO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoY2hhbmdlZC5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLl92aWV3YWJsZUl0ZW1zID0gbmV4dEl0ZW1zO1xuICAgICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCh7XG4gICAgICAgIHZpZXdhYmxlSXRlbXM6IEFycmF5LmZyb20obmV4dEl0ZW1zLnZhbHVlcygpKSxcbiAgICAgICAgY2hhbmdlZCxcbiAgICAgICAgdmlld2FiaWxpdHlDb25maWc6IHRoaXMuX2NvbmZpZyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBfaXNWaWV3YWJsZShcbiAgdmlld0FyZWFNb2RlOiBib29sZWFuLFxuICB2aWV3YWJsZVBlcmNlbnRUaHJlc2hvbGQ6IG51bWJlcixcbiAgdG9wOiBudW1iZXIsXG4gIGJvdHRvbTogbnVtYmVyLFxuICB2aWV3cG9ydEhlaWdodDogbnVtYmVyLFxuICBpdGVtTGVuZ3RoOiBudW1iZXIsXG4pOiBib29sZWFuIHtcbiAgaWYgKF9pc0VudGlyZWx5VmlzaWJsZSh0b3AsIGJvdHRvbSwgdmlld3BvcnRIZWlnaHQpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgcGl4ZWxzID0gX2dldFBpeGVsc1Zpc2libGUodG9wLCBib3R0b20sIHZpZXdwb3J0SGVpZ2h0KTtcbiAgICBjb25zdCBwZXJjZW50ID1cbiAgICAgIDEwMCAqICh2aWV3QXJlYU1vZGUgPyBwaXhlbHMgLyB2aWV3cG9ydEhlaWdodCA6IHBpeGVscyAvIGl0ZW1MZW5ndGgpO1xuICAgIHJldHVybiBwZXJjZW50ID49IHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZDtcbiAgfVxufVxuXG5mdW5jdGlvbiBfZ2V0UGl4ZWxzVmlzaWJsZShcbiAgdG9wOiBudW1iZXIsXG4gIGJvdHRvbTogbnVtYmVyLFxuICB2aWV3cG9ydEhlaWdodDogbnVtYmVyLFxuKTogbnVtYmVyIHtcbiAgY29uc3QgdmlzaWJsZUhlaWdodCA9IE1hdGgubWluKGJvdHRvbSwgdmlld3BvcnRIZWlnaHQpIC0gTWF0aC5tYXgodG9wLCAwKTtcbiAgcmV0dXJuIE1hdGgubWF4KDAsIHZpc2libGVIZWlnaHQpO1xufVxuXG5mdW5jdGlvbiBfaXNFbnRpcmVseVZpc2libGUoXG4gIHRvcDogbnVtYmVyLFxuICBib3R0b206IG51bWJlcixcbiAgdmlld3BvcnRIZWlnaHQ6IG51bWJlcixcbik6IGJvb2xlYW4ge1xuICByZXR1cm4gdG9wID49IDAgJiYgYm90dG9tIDw9IHZpZXdwb3J0SGVpZ2h0ICYmIGJvdHRvbSA+IHRvcDtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBWaWV3YWJpbGl0eUhlbHBlcjtcbiJdfQ==